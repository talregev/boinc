app-id: edu.berkeley.BOINC
runtime: org.gnome.Platform
runtime-version: '42'
sdk: org.gnome.Sdk
command: boincmgr
finish-args:
  - --share=ipc
  - --socket=x11
  - --socket=pulseaudio
  - --share=network
  - --device=dri
  - --persist=.BOINC
  - --persist=.

modules:
  # - name: glu
  #   sources:
  #     - type: git
  #       url: https://github.com/flathub/shared-modules
  #     - type: file
  #       path: glu/glu-9.json

  - name: glu
    sources:
      - type: archive
        url:  https://mesa.freedesktop.org/archive/glu/glu-9.0.2.tar.xz
        sha256: 6e7280ff585c6a1d9dfcdf2fca489251634b3377bfc33c29e4002466a38d02d4
    # cleanup: 
    #   - /include
    #   - /lib/*.a
    #   - /lib/*.la 
    #   - /lib/pkgconfig

  ##### freeglut and libXmu needed for projects that display graphics
  ##### https://boinc.berkeley.edu/trac/wiki/GraphicsApi#api
  - name: freeglut
    buildsystem: cmake-ninja
    build-options:
      cflags: -fcommon
    sources:
      - type: archive
        url: https://downloads.sourceforge.net/freeglut/freeglut-3.2.1.tar.gz
        sha256: d4000e02102acaf259998c870e25214739d1f16f67f99cb35e4f46841399da68
    cleanup:
      - /include

  - name: libXmu
    sources:
      - type: archive
        url: https://www.x.org/releases/individual/lib/libXmu-1.1.3.tar.gz
        sha256: 5bd9d4ed1ceaac9ea023d86bf1c1632cd3b172dce4a193a72a94e1d9df87a62e
    cleanup:
      - /include
      - /share

  - name: libXi
    sources:
      - type: archive
        url: https://www.x.org/releases/individual/lib/libXi-1.8.tar.gz
        sha256: c80fd200a1190e4406bb4cc6958839d9651638cb47fa546a595d4bebcd3b9e2d
    cleanup:
      - /include
      - /share
      
  #####

  - name: vcpkg
    sources:
      - type: dir
        path: "."  
    build-options:
      build-args:
        - --share=network
    buildsystem: simple
    build-commands:
      - linux/update_vcpkg_manager.sh

  # - name: boinc
  #   buildsystem: autotools
  #   config-opts:
  #     - --with-libcurl=$PWD/3rdParty/linux/vcpkg/installed/x64-linux
  #     - --with-ssl=$PWD/3rdParty/linux/vcpkg/installed/x64-linux
  #     - --with-wx-config=$VCPKG_DIR/tools/wxwidgets/wx-config
  #     - --enable-client
  #     - --enable-manager
  #     - --disable-server
  #     - GTK_LIBS="`pkg-config --libs gtk+-3.0 webkit2gtk-4.0 x11` -lgmodule-2.0 -ldl -lffi -lpcre -lmount -lselinux -lresolv -lz -lpcre2-32"
  #   make-install-args:
  #     - DESTDIR=${FLATPAK_DEST}
  #     - prefix=
  #     - exec_prefix=
  #   build-options:
  #     build-args:
  #       - --share=network
  #     env:
  #       CRYPTOGRAPHY_DONT_BUILD_RUST: "1"
  #       _libcurl_pc: "3rdParty/linux/vcpkg/installed/x64-linux/lib/pkgconfig/libcurl.pc"
  #   secret-env:
  #     - VCPKG_BINARY_SOURCES
  #     - AWS_ACCESS_KEY_ID
  #     - AWS_SECRET_ACCESS_KEY
  #     - AWS_DEFAULT_REGION
  #   sources:
  #     - type: dir
  #       path: "."
  #     - type: file
  #       path: edu.berkeley.BOINC.metainfo.xml
  #     - type: shell
  #       commands:      
  #         - ./_autosetup        
  #   post-install:
  #     ### Overwrite BOINCDIR or else it will warn that it can't find gui_rpc_auth.cfg
  #     - sed -i 's:#BOINCDIR=/var/lib/boinc:BOINCDIR=/:' ${FLATPAK_DEST}/etc/boinc-client.conf
  #     - install -Dm644 clientgui/res/boinc.svg ${FLATPAK_DEST}/share/icons/hicolor/scalable/apps/${FLATPAK_ID}.svg
  #     - install -Dm644 clientgui/res/boinc.desktop ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop
  #     - install -Dm644 edu.berkeley.BOINC.metainfo.xml ${FLATPAK_DEST}/share/metainfo/${FLATPAK_ID}.metainfo.xml
  #     - desktop-file-edit --remove-key=Path ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop
  #     - desktop-file-edit --set-icon=${FLATPAK_ID} ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop
  #   cleanup:
  #     - /usr
